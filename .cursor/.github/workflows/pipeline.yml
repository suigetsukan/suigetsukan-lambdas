# Single pipeline: validate/lint on every push and PR; reconcile orgs on push only.
# Reconcile requires repo secret GH_TOKEN (PAT with repo + read:org and push access to org repos and this repo).

name: Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    name: Validate rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate .mdc frontmatter
        run: python scripts/validate_mdc.py

      - name: Run unit tests
        run: python -m pytest tests/ -v

  install-script:
    name: Install script (bats)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Bats
        uses: bats-core/bats-action@v3.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run install.sh tests
        run: bats tests/install.bats

  markdown:
    name: Markdown lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: avto-dev/markdown-lint@v1
        with:
          args: "*.md docs/*.md rules/*.mdc"
          config: ".markdownlint.json"

  reconcile:
    name: Reconcile orgs
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gh
        run: |
          type -p gh >/dev/null && exit 0
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Reconcile orgs
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          while IFS= read -r org || [ -n "$org" ]; do
            [[ -z "$org" || "$org" = \#* ]] && continue
            ./scripts/install-org.sh "$org"
          done < .github/orgs-to-update.txt
